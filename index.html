<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Calorías por Foto</title>
    <!-- Incluir Tailwind CSS CDN para un estilo moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuración global para usar la fuente Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Estilo para el contenedor del resultado */
        .result-box {
            background-color: #ffffff;
            border-left: 5px solid #3b82f6; /* Color azul de acento */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 md:p-8">

    <div id="app" class="w-full max-w-xl bg-white rounded-xl shadow-2xl p-6 md:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">
            Calorías por Foto 📸
        </h1>
        <p class="text-sm text-gray-500 mb-6 text-center">
            Sube o toma una foto de tu comida para obtener una estimación nutricional.
        </p>

        <!-- Área de Carga de Imagen y Previsualización -->
        <div class="mb-6 border-2 border-dashed border-blue-300 p-4 rounded-lg bg-blue-50 hover:bg-blue-100 transition-colors">
            <input type="file" id="imageInput" accept="image/*" capture="camera" class="hidden" onchange="handleImageUpload(event)">
            <label for="imageInput" class="flex flex-col items-center justify-center cursor-pointer p-4">
                <svg class="w-10 h-10 text-blue-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <span class="text-sm font-semibold text-blue-700">Toca aquí para subir o tomar una foto</span>
            </label>
        </div>

        <!-- Previsualización de la Imagen -->
        <div id="imagePreviewContainer" class="mb-6 hidden">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">Previsualización:</h2>
            <img id="imagePreview" class="w-full max-h-80 object-contain rounded-lg shadow-md border border-gray-200" alt="Previsualización de la comida">
        </div>

        <!-- Botón de Cálculo -->
        <button id="calculateButton" onclick="calculateCalories()" disabled class="w-full py-3 px-4 bg-gray-400 text-white font-bold rounded-lg transition-colors duration-300 opacity-70 cursor-not-allowed shadow-md">
            Calcular Calorías
        </button>

        <!-- Área de Carga (Spinner) -->
        <div id="loadingIndicator" class="hidden text-center mt-6 p-4 rounded-lg bg-yellow-100 border border-yellow-300">
            <div class="flex items-center justify-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-yellow-800 font-medium">Analizando la imagen... Por favor, espera.</span>
            </div>
        </div>

        <!-- Área de Resultados y Mensajes -->
        <div id="resultOutput" class="mt-6">
            <!-- Los resultados de la API se insertarán aquí -->
        </div>

        <!-- Área de Mensajes de Error -->
        <div id="errorBox" class="hidden mt-6 p-4 bg-red-100 text-red-700 border border-red-400 rounded-lg" role="alert">
            <p class="font-bold">Error:</p>
            <p id="errorMessage"></p>
        </div>
    </div>

    <script>
        // Variables globales para el estado de la aplicación
        let base64Image = null;
        const resultOutput = document.getElementById('resultOutput');
        const imagePreview = document.getElementById('imagePreview');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const calculateButton = document.getElementById('calculateButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');

        // URL y API Key para Gemini (gemini-2.5-flash-preview-05-20 para multimodal)
        const MODEL_NAME = 'gemini-2.5-flash-preview-05-20';
        const apiKey = ""; // La clave será proporcionada por el entorno de Canvas si está vacía.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

        // Función para mostrar mensajes de error
        function displayError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');
            calculateButton.disabled = false;
            calculateButton.classList.replace('bg-blue-600', 'bg-red-500');
            calculateButton.classList.replace('opacity-100', 'opacity-70');
            calculateButton.classList.add('cursor-pointer');
            calculateButton.classList.remove('cursor-not-allowed');
        }

        // Función para convertir ArrayBuffer a Base64 (necesario para la API)
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        // 1. Manejar la carga de la imagen (archivo o cámara)
        window.handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (!file) {
                base64Image = null;
                imagePreviewContainer.classList.add('hidden');
                calculateButton.disabled = true;
                calculateButton.classList.replace('bg-blue-600', 'bg-gray-400');
                calculateButton.classList.replace('opacity-100', 'opacity-70');
                calculateButton.classList.add('cursor-not-allowed');
                return;
            }

            // Ocultar resultados anteriores y errores
            resultOutput.innerHTML = '';
            errorBox.classList.add('hidden');

            const reader = new FileReader();

            reader.onload = (e) => {
                // Previsualizar la imagen
                imagePreview.src = e.target.result;
                imagePreviewContainer.classList.remove('hidden');

                // Convertir a Base64
                const mimeType = file.type;
                const base64Data = e.target.result.split(',')[1];
                base64Image = { mimeType, data: base64Data };

                // Habilitar el botón de cálculo
                calculateButton.disabled = false;
                calculateButton.classList.replace('bg-gray-400', 'bg-blue-600');
                calculateButton.classList.replace('opacity-70', 'opacity-100');
                calculateButton.classList.remove('cursor-not-allowed');
                calculateButton.classList.add('cursor-pointer');
            };

            reader.readAsDataURL(file);
        };

        // 2. Función para manejar la lógica de reintento con retroceso exponencial
        async function retryFetch(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 || response.status >= 500) {
                        // Error de tasa límite o del servidor, reintentar
                        if (i === maxRetries - 1) throw new Error(`El servidor falló después de ${maxRetries} intentos.`);
                        
                        const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000); // 1s, 2s, 4s, 8s, 16s + jitter
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Error de API: ${errorData.error?.message || response.statusText}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // Retrasar antes de reintentar
                    const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        // 3. Llamar a la API de Gemini
        window.calculateCalories = async () => {
            if (!base64Image) {
                displayError("Por favor, selecciona una imagen primero.");
                return;
            }

            // Limpiar área de resultados y error
            resultOutput.innerHTML = '';
            errorBox.classList.add('hidden');

            // Mostrar el indicador de carga
            loadingIndicator.classList.remove('hidden');
            calculateButton.disabled = true;
            calculateButton.textContent = 'Analizando...';

            const systemPrompt = "Eres un experto en nutrición y análisis de alimentos. Tu tarea es analizar la imagen de comida proporcionada, estimar las porciones de los alimentos visibles, y calcular el contenido calórico total aproximado. Proporciona tu respuesta SÓLO en español. El formato de la respuesta debe ser: 1. Un encabezado en negrita con el Nombre del Plato (inventa uno si es necesario). 2. La Estimación de Calorías TOTALES. 3. Una tabla simple o una lista con un Resumen Nutricional Breve (Carbohidratos, Proteínas, Grasas). 4. Un análisis de la Composición del Plato (los ingredientes que detectaste y por qué calculaste esa cantidad de calorías).";
            
            const userQuery = "Analiza esta comida, estima las porciones y dime las calorías aproximadas. Proporciona un resumen nutricional breve basado en tu estimación. No necesitas usar Google Search.";

            const payload = {
                contents: [{ 
                    parts: [
                        { text: userQuery },
                        { inlineData: base64Image }
                    ] 
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                // No se usa Google Search para esta tarea de visión
            };

            try {
                const response = await retryFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!text) {
                    throw new Error("La API no devolvió una respuesta válida o el contenido está vacío.");
                }

                // 4. Mostrar el resultado
                loadingIndicator.classList.add('hidden');
                resultOutput.innerHTML = `
                    <div class="result-box p-4 rounded-lg">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Análisis Nutricional Estimado</h2>
                        <div class="prose max-w-none text-gray-700">
                            ${text.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">
                        *Nota: Esta es una estimación generada por IA. Consulta a un profesional para datos nutricionales precisos.
                    </p>
                `;

            } catch (error) {
                console.error("Error en el cálculo de calorías:", error);
                displayError(`No se pudo completar el análisis. ${error.message}`);
            } finally {
                // Restablecer el botón
                calculateButton.disabled = false;
                calculateButton.textContent = 'Calcular Calorías';
                loadingIndicator.classList.add('hidden');
            }
        };

        // Inicialización para evitar que el botón quede desactivado si no hay imagen
        document.addEventListener('DOMContentLoaded', () => {
            calculateButton.textContent = 'Calcular Calorías';
            calculateButton.disabled = true;
            calculateButton.classList.replace('bg-blue-600', 'bg-gray-400');
            calculateButton.classList.replace('opacity-100', 'opacity-70');
            calculateButton.classList.add('cursor-not-allowed');
        });
    </script>
</body>
</html>
